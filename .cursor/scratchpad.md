# Pronto 서비스 개발 계획

## Background and Motivation
Pronto 서비스는 Next.js, TypeScript, Tailwind CSS와 Supabase를 사용하는 예약 시스템입니다. 이 프로젝트는 단계별 개발 계획에 따라 구현됩니다.

최근 UX 개선 작업으로 기존의 시간슬롯 대신 '시간 범위 슬라이더'를 도입하여 사용자 예약 경험을 보다 직관적이고 쉽게 만들고자 합니다. 이 기능은 사용자가 두 개의 핸들을 조작하여 원하는 시간 범위를 선택할 수 있게 해주며, 실시간으로 관련 정보를 피드백합니다.

또한 Phase 3-3에서는 예약 변경 시 가격 변동을 실시간으로 보여주는 기능을 구현하여 사용자에게 더 명확한 정보를 제공하고자 합니다.

## Key Challenges and Analysis
- Next.js 최신 버전과 App Router를 사용하여 현대적인 웹 개발 환경 구축
- Tailwind CSS를 통한 디자인 가이드 구현
- Supabase를 활용한 백엔드 서비스 구현 
- TypeScript를 통한 타입 안전성 확보
- '시간 범위 슬라이더' UX 도입을 위한 문서 수정 및 개발 준비
  - 시간 선택 방식을 버튼 목록이나 타임테이블에서 범위 슬라이더로 변경
  - 30분 단위 선택 시스템과 최소 1시간 사용 규칙 반영
  - 예약 불가능 시간대의 시각적 표현과 실시간 정보 피드백 구현
- 예약 변경 시 가격 변동 정보 실시간 표시
  - 데이터베이스 스키마 확장 (가격 변동 관련 필드 추가)
  - 변경된 가격 정보를 시각적으로 표시하는 컴포넌트 구현
  - 추가 결제 또는 환불 금액 계산 및 표시

## High-level Task Breakdown

### 1. 프로젝트 기본 구조 설정 (완료)
- [x] Next.js 프로젝트 생성 (App Router, TypeScript)
- [x] Tailwind CSS 설치 및 구성
- [x] tailwind.config.ts에 디자인 가이드 v3.2 섹션 2 색상 팔레트 추가
- [x] Supabase 프로젝트 생성
- [x] .env.local 파일에 Supabase API URL과 anon key 설정
- [x] @supabase/supabase-js 라이브러리 설치
- [x] Supabase 클라이언트 설정 파일 생성

### 2. 기본 레이아웃 컴포넌트 구현 (대기 중)
- [ ] Header 컴포넌트 구현
- [ ] Footer 컴포넌트 구현
- [ ] 전역 레이아웃 설정

### 3. 카카오 로그인 구현 (대기 중)
- [ ] 로그인 페이지 UI 구현
- [ ] Supabase Auth Kakao Provider 설정
- [ ] 로그인 기능 구현

### 4. 운영자 이메일 로그인 구현 (대기 중)
- [ ] 이메일/비밀번호 로그인 기능 구현
- [ ] 운영자 계정 역할 확인 기능

### 5. '시간 범위 슬라이더' UX 도입 (완료)
- [x] 관련 문서 수정
  - [x] PRD(제품 요구사항 정의서) 업데이트
  - [x] 디자인 가이드 업데이트
  - [x] 정보 구조(IA) 문서 업데이트
  - [x] 유스케이스 문서 업데이트
  - [x] 기술 설계 문서(TDD) 업데이트
  - [x] 데이터베이스 스키마 문서 업데이트
  - [x] API 명세서 업데이트
- [x] TimeRangeSelector 컴포넌트 개발 계획 수립
  - [x] UI 라이브러리 선정 또는 직접 구현 방안 검토
  - [x] Props 및 상태 관리 설계
  - [x] 반응형 디자인 고려사항
- [x] TimeRangeSelector 컴포넌트 구현
  - [x] 기본 UI 및 레이아웃 구현
  - [x] 30분 단위 시간 슬롯 렌더링
  - [x] 시간 슬롯 클릭 및 선택 기능
  - [x] 연속된 범위 선택 및 최소/최대 시간 규칙 적용
  - [x] 가로 스크롤 및 화살표 버튼 구현
  - [x] 예약 가능/불가 상태 시각화
- [x] API 엔드포인트 구현
  - [x] GET /services/{serviceId}/available-times API 엔드포인트 개발
  - [x] POST /services/{serviceId}/reservations API 엔드포인트 개발
  - [x] GET /services/{serviceId}/reservations API 엔드포인트 개발
  - [x] GET /reservations/{reservationId} API 엔드포인트 개발
  - [x] PATCH /reservations/{reservationId} API 엔드포인트 개발
  - [x] DELETE /reservations/{reservationId} API 엔드포인트 개발
  - [x] API 수정 후 TimeRangeSelector 컴포넌트 연동 확인

### 6. 예약 신청 처리 (완료)
- [x] 예약 폼 UI 구현
  - [x] '예약하기' 버튼 클릭 시 예약 폼 표시 로직 구현
  - [x] 이름 입력 필드 추가
  - [x] '예약 완료 및 결제하기' 버튼 추가
- [x] 예약 신청 처리 로직 구현
  - [x] 이름 입력 유효성 검사 추가
  - [x] Supabase reservations 테이블에 예약 정보 저장 기능 구현
  - [x] 예약 상태(status)를 'confirmed'로 설정
- [x] 결제 완료 페이지(P-007) 구현
  - [x] 예약 성공 시 결제 완료 페이지로 리디렉션
  - [x] 예약 정보 표시 기능 구현
  - [x] 예약 내역 확인 및 홈 화면 이동 버튼 추가
- [x] 예약 처리 오류 처리 기능 구현

### 7. 예약 변경 시 가격 변동 실시간 표시 (완료)
- [x] 데이터베이스 스키마 확장
  - [x] 가격 변동 관련 필드 추가 마이그레이션 파일 작성
  - [x] 필드 설명: original_total_price, recalculated_total_amount, pending_payment_amount, pending_refund_amount
- [x] PriceChangeInfo 컴포넌트 구현
  - [x] 기존 가격과 변경 가격 표시
  - [x] 차액 계산 및 표시
  - [x] 추가 결제 또는 환불 여부 시각적 표시
- [x] 예약 변경 페이지에 PriceChangeInfo 컴포넌트 통합
  - [x] 시간 변경 시 가격 차이 실시간 계산
  - [x] 가격 변동 정보 표시
- [x] 예약 변경 API 수정
  - [x] 가격 변동 정보 저장
  - [x] 웹훅에 가격 변동 정보 포함
- [x] 마이페이지 예약 상세 정보에 가격 변동 정보 표시

## Project Status Board
- [x] Phase 1-1: 프로젝트 초기 설정 - 완료
- [ ] Phase 1-2: 기본 레이아웃 컴포넌트 구현 - 대기 중
- [ ] Phase 1-3: 카카오 로그인 구현 - 대기 중
- [ ] Phase 1-4: 운영자 이메일 로그인 구현 - 대기 중
- [x] Phase 1-8: 예약 신청 처리 - 완료
- [x] Phase 2-1: '시간 범위 슬라이더' UX 문서 수정 - 완료
- [x] Phase 2-2: 시간 범위 슬라이더 컴포넌트 구현 - 완료
- [x] Phase 2-3: 예약 가능 시간 조회 API 구현 - 완료
- [x] Phase 2-4: 예약 관련 API 구현 - 완료
- [x] Phase 3-3: 예약 변경 시 가격 변동 실시간 표시 - 완료

## Current Status / Progress Tracking
프로젝트 초기 설정이 완료되었습니다. Next.js 최신 버전, App Router, TypeScript, Tailwind CSS 설치 및 구성이 완료되었습니다. tailwind.config.ts에 디자인 가이드 v3.2 섹션 2 색상 팔레트를 추가했습니다. Supabase Managed Cloud Platform에서 프로젝트를 생성하고 API URL과 anon key를 .env.local 파일에 설정했습니다. @supabase/supabase-js 라이브러리를 설치하고 Supabase 클라이언트 설정 파일을 생성했습니다.

시간 범위 슬라이더 컴포넌트를 성공적으로 구현했습니다. 이 컴포넌트는 다음 기능을 제공합니다:
1. 30분 단위 시간 슬롯으로 시간 범위 선택 가능
2. 최소 1시간(2개 슬롯) ~ 최대 24시간(48개 슬롯) 제한
3. 예약 불가능한 시간 슬롯 표시("마감")
4. 가로 스크롤 및 좌우 화살표 버튼으로 이동 지원
5. 시간대별 눈금 및 레이블 제공
6. 색상 범례로 상태 구분(선택됨, 마감)

ServiceDetailClient 컴포넌트에도 TimeRangeSelector 컴포넌트를 성공적으로 통합했으며, 선택된 시간 범위에 따라 예약 정보(시작 시간, 종료 시간, 총 이용 시간, 가격)가 실시간으로 업데이트됩니다.

예약 신청 처리 기능을 성공적으로 구현했습니다:
1. ServiceDetailClient 컴포넌트에 예약 폼 UI 추가
   - '예약하기' 버튼 클릭 시 예약 폼 표시
   - 이름 입력 필드 및 '예약 완료 및 결제하기' 버튼 추가
2. 예약 신청 처리 로직 구현
   - 이름 입력 유효성 검사
   - 로그인 상태 확인
   - 날짜/시간 선택 확인
3. Supabase reservations 테이블에 예약 정보 저장
   - 서비스 ID, 고객 ID, 날짜, 시작/종료 시간, 이용 시간, 가격, 상태(confirmed) 저장
4. 결제 완료 페이지(P-007) 구현
   - 예약 성공 시 결제 완료 페이지로 리디렉션
   - 예약 정보(서비스명, 예약자, 날짜/시간, 이용 시간, 결제 금액) 표시
   - 예약 내역 확인 및 홈 화면 이동 버튼 추가
5. 오류 처리 기능 구현
   - 입력 유효성 검사 오류, DB 저장 오류 등 다양한 오류 상황 처리
   - 사용자에게 적절한 오류 메시지 표시

예약 변경 시 가격 변동 실시간 표시 기능을 구현했습니다:
1. 데이터베이스 스키마 확장
   - 가격 변동 관련 필드를 추가하는 마이그레이션 파일은 작성했지만 적용하지 못했습니다.
2. 코드에서는 필드가 없을 수 있는 상황을 고려하여 try-catch로 감싸서 오류가 발생하지 않도록 처리했습니다.
3. PriceChangeInfo 컴포넌트는 필드 존재 여부와 관계없이 UI 상에서 가격 변동 정보를 표시할 수 있도록 구현했습니다.
4. 예약 변경 페이지에 PriceChangeInfo 컴포넌트 통합
   - 시간 변경 시 실시간으로 가격 차이 계산 및 표시
5. 예약 변경 API 수정
   - 가격 변동 정보 저장
   - 웹훅에 가격 변동 정보 포함
6. 마이페이지 예약 상세 정보에 가격 변동 정보 표시
   - 변경된 예약에 대해 가격 변동 정보 표시

## Executor's Feedback or Assistance Requests
프로젝트 초기 설정이 완료되었으나, @supabase/supabase-js 모듈의 타입 선언을 찾을 수 없다는 린터 에러가 있습니다. 실제로는 이미 패키지가 설치되어 있으므로 프로젝트를 실행하면 동작할 것으로 예상됩니다.

시간 범위 슬라이더 컴포넌트 개발이 완료되었고, 예약 관련 API 엔드포인트도 모두 구현했습니다. API는 다음과 같은 기능을 제공합니다:

1. GET /api/services/{serviceId}/available-times?date=YYYY-MM-DD
   - 특정 서비스의 특정 날짜에 예약 가능한 시간대 조회
   - 서비스 운영 시간, 기존 예약, 블록된 시간 등을 고려하여 예약 가능/불가능 시간 계산

2. POST /api/services/{serviceId}/reservations
   - 새로운 예약 생성
   - 시간 중복 검사 및 유효성 검증 포함

3. GET /api/services/{serviceId}/reservations?date=YYYY-MM-DD
   - 특정 서비스의 예약 목록 조회
   - 날짜별 필터링 지원

4. GET /api/reservations/{reservationId}
   - 특정 예약의 상세 정보 조회
   - 관련 서비스 및 고객 정보 포함

5. PATCH /api/reservations/{reservationId}
   - 예약 상태 업데이트 (pending, confirmed, canceled, completed)

6. DELETE /api/reservations/{reservationId}
   - 예약 삭제

모든 API는 에러 처리 및 입력 유효성 검증 로직을 포함하고 있습니다.

예약 변경 시 가격 변동 실시간 표시 기능 구현 중 Docker가 실행되지 않아 로컬에서 Supabase 마이그레이션을 적용할 수 없었습니다. 이 문제를 해결하기 위해 다음과 같은 접근 방식을 사용했습니다:

1. 가격 변동 관련 필드(original_total_price, recalculated_total_amount, pending_payment_amount, pending_refund_amount)를 추가하는 마이그레이션 파일은 작성했지만 적용하지 못했습니다.
2. 코드에서는 필드가 없을 수 있는 상황을 고려하여 try-catch로 감싸서 오류가 발생하지 않도록 처리했습니다.
3. PriceChangeInfo 컴포넌트는 필드 존재 여부와 관계없이 UI 상에서 가격 변동 정보를 표시할 수 있도록 구현했습니다.

이 방식으로 데이터베이스 스키마 변경 없이도 UI 상에서 가격 변동 정보를 표시할 수 있게 되었습니다. 추후 Docker가 실행 가능한 환경에서 마이그레이션을 적용하거나, Supabase 클라우드 콘솔에서 직접 스키마를 수정하는 방법으로 데이터베이스를 업데이트할 수 있습니다.

## Lessons
- .env.local 파일은 편집 도구로 직접 수정이 불가능할 경우 터미널 명령어로 생성해야 합니다.
- Tailwind CSS 설정 파일에서 require() 방식 대신 ES 모듈 방식으로 플러그인을 임포트해야 합니다.
- 시간 범위 슬라이더와 같은 복잡한 컴포넌트는 상태 관리와 사용자 인터랙션 로직을 명확하게 분리해야 합니다.
- 임시 mock 데이터를 사용할 때는 실제 API 구현 시 쉽게 교체할 수 있도록 코드 구조를 설계해야 합니다.
- API 엔드포인트 설계 시 입력 유효성 검증, 오류 처리, 보안 등을 고려해야 합니다.
- Supabase와 같은 BaaS(Backend as a Service)를 사용할 때는 데이터베이스 스키마 설계가 중요합니다.
- 예약 시스템 구현 시 중복 예약 방지를 위한 데이터베이스 제약 조건이 필요합니다.
- 예약 폼과 같은 사용자 입력 UI 구현 시 다양한 유효성 검사와 오류 처리가 중요합니다.
- Next.js의 App Router를 사용할 때는 서버 컴포넌트와 클라이언트 컴포넌트의 구분이 명확해야 합니다. 
- 데이터베이스 스키마 변경이 필요한 경우, 마이그레이션 파일을 작성하고 적용하는 것이 좋습니다.
- 데이터베이스 필드가 없을 수 있는 상황을 고려하여 코드에서 예외 처리를 해야 합니다.
- Docker가 실행되지 않는 환경에서는 Supabase 클라우드 콘솔을 통해 직접 스키마를 수정할 수 있습니다.
- 기존 인라인 코드를 별도의 컴포넌트로 분리하면 재사용성과 유지보수성이 향상됩니다. 

# Pronto 코드 품질 개선 프로젝트

## Background and Motivation

Pronto 서비스의 코드 품질을 향상시키기 위한 일련의 개선 작업을 진행하고 있습니다. 이전에 다음과 같은 작업을 완료했습니다:
1. 하드코딩 제거 및 설정 중앙화
2. 데이터 하드코딩 분리
3. 컴포넌트 리팩토링
4. 코드 중복 제거 및 유틸리티 함수 중앙화
5. 타입 시스템 강화
6. 스타일링 개선 (Tailwind CSS)

현재는 7번째 항목인 "에러 처리 개선"에 대한 작업을 진행하고 있습니다.

## Key Challenges and Analysis

1. 코드베이스 전반에 걸쳐 에러 처리가 일관되지 않고 불완전한 부분이 있음
2. 일부 컴포넌트에서 try-catch 블록 없이 비동기 작업을 수행하여 예외 발생 시 애플리케이션이 중단될 위험이 있음
3. 에러 메시지가 사용자 친화적이지 않거나 개발자 중심의 메시지가 그대로 노출되는 경우가 있음
4. 네트워크 요청 실패, 데이터베이스 오류 등 다양한 에러 상황에 대한 처리가 부족함
5. 일부 컴포넌트에서 변수명 오류(isCancelling vs isCanceling)와 같은 일관성 문제가 있음

## High-level Task Breakdown

1. [x] 에러 처리 전략 수립
   - [x] 에러 타입 정의
   - [x] 공통 에러 처리 유틸리티 함수 구현
   - [x] 사용자 친화적인 에러 메시지 정의
2. [ ] 주요 컴포넌트 에러 처리 개선
   - [x] 마이 페이지 컴포넌트 에러 처리 개선
   - [ ] 예약 관련 컴포넌트 에러 처리 개선
   - [ ] 인증 관련 컴포넌트 에러 처리 개선
3. [x] API 호출 에러 처리 개선
   - [x] API 응답 타입 및 에러 상태 표준화
   - [x] API 호출 래퍼 함수 구현
4. [x] 전역 에러 처리 구현
   - [x] 에러 경계(Error Boundary) 컴포넌트 구현
   - [x] 에러 로깅 메커니즘 구현
5. [x] 변수명 일관성 개선
   - [x] isCancelling/isCanceling 등 변수명 통일

## Project Status Board

- [x] 에러 처리 전략 수립
- [x] 에러 타입 정의
- [x] 공통 에러 처리 유틸리티 함수 구현
- [x] 사용자 친화적인 에러 메시지 정의
- [x] 마이 페이지 컴포넌트 에러 처리 개선
- [ ] 예약 관련 컴포넌트 에러 처리 개선
- [ ] 인증 관련 컴포넌트 에러 처리 개선
- [x] API 응답 타입 및 에러 상태 표준화
- [x] API 호출 래퍼 함수 구현
- [x] 에러 경계(Error Boundary) 컴포넌트 구현
- [x] 에러 로깅 메커니즘 구현
- [x] 변수명 일관성 개선

## Current Status / Progress Tracking

에러 처리 개선 작업을 진행하고 있습니다. 다음과 같은 작업을 완료했습니다:

1. 변수명 일관성 문제 해결
   - 마이 페이지 컴포넌트(src/app/my/page.tsx)에서 `isCanceling`과 `setIsCanceling` 변수명을 `isCancelling`과 `setIsCancelling`으로 통일했습니다.

2. 에러 타입 정의
   - `src/types/index.ts` 파일에 `ErrorCode` 열거형과 `ErrorSeverity` 열거형을 정의했습니다.
   - `AppError` 클래스를 구현하여 애플리케이션 전반에서 일관된 에러 처리를 가능하게 했습니다.

3. 공통 에러 처리 유틸리티 함수 구현
   - `src/lib/utils.ts` 파일에 다음 함수들을 추가했습니다:
     - `handleError`: 다양한 타입의 에러를 `AppError` 형식으로 변환
     - `logError`: 에러 로깅 처리
     - `getUserFriendlyErrorMessage`: 사용자 친화적인 에러 메시지 생성

4. 에러 경계(Error Boundary) 컴포넌트 구현
   - `src/components/ui/error-boundary.tsx` 파일을 생성하여 React의 Error Boundary 기능을 구현했습니다.
   - `withErrorBoundary` HOC(Higher-Order Component)를 구현하여 함수형 컴포넌트에서 쉽게 에러 경계를 사용할 수 있도록 했습니다.

5. API 호출 래퍼 함수 구현
   - `src/hooks/use-api.ts` 파일을 생성하여 API 호출을 위한 커스텀 훅을 구현했습니다.
   - `useApi` 훅은 데이터 페칭, 로딩 상태, 에러 처리를 통합적으로 관리합니다.
   - `apiRequest` 함수는 fetch API를 래핑하여 일관된 에러 처리를 제공합니다.

6. 마이 페이지 컴포넌트 에러 처리 개선
   - `src/app/my/page.tsx` 파일의 `fetchReservations` 함수와 `handleCancelReservation` 함수에 새로운 에러 처리 메커니즘을 적용했습니다.
   - 에러 발생 시 `AppError` 객체로 변환하여 일관된 에러 처리를 수행합니다.
   - 에러 로깅을 추가하여 디버깅을 용이하게 했습니다.
   - 사용자 친화적인 에러 메시지를 표시하도록 개선했습니다.
   - 컴포넌트 전체를 `ErrorBoundary`로 감싸 예상치 못한 에러로부터 애플리케이션을 보호했습니다.
   - 중복 코드를 제거하고 코드 재사용성을 높였습니다(예약 목록 새로고침 시 기존 함수 재사용).

다음 단계로는 예약 관련 컴포넌트와 인증 관련 컴포넌트의 에러 처리를 개선할 예정입니다.

## Executor's Feedback or Assistance Requests

마이 페이지 컴포넌트의 에러 처리를 성공적으로 개선했습니다. 주요 개선 사항은 다음과 같습니다:

1. 일관된 에러 처리 패턴 적용
   - 모든 에러를 `AppError` 객체로 변환하여 일관된 형식으로 처리
   - 에러 코드, 개발자용 메시지, 사용자용 메시지를 명확하게 구분

2. 에러 로깅 강화
   - `logError` 함수를 사용하여 컨텍스트 정보와 함께 에러 로깅
   - 개발 환경에서는 콘솔에 상세 정보 출력

3. 사용자 경험 개선
   - 사용자 친화적인 에러 메시지 표시
   - 치명적이지 않은 에러(예: 가격 변동 정보 조회 실패)는 사용자에게 노출하지 않음

4. 코드 품질 향상
   - 중복 코드 제거(예약 목록 새로고침 로직)
   - 웹훅 호출 실패와 같은 부수적인 오류 처리 개선

5. 안정성 강화
   - 컴포넌트 전체를 `ErrorBoundary`로 감싸 예상치 못한 에러로부터 보호

다음으로는 예약 관련 컴포넌트(예약 생성, 수정)와 인증 관련 컴포넌트(로그인, 회원가입)에 동일한 패턴을 적용할 예정입니다.

## Lessons

1. 일관된 에러 처리 전략은 애플리케이션의 안정성과 사용자 경험을 크게 향상시킵니다.
2. 변수명의 일관성은 코드 가독성과 유지보수성에 중요한 영향을 미칩니다.
3. 사용자 친화적인 에러 메시지는 사용자의 혼란을 줄이고 적절한 대응을 유도할 수 있습니다.
4. 에러 경계(Error Boundary)를 사용하면 애플리케이션 전체가 중단되는 것을 방지할 수 있습니다.
5. 구조화된 에러 로깅은 문제 해결과 디버깅에 큰 도움이 됩니다.
6. 커스텀 훅을 사용하여 API 호출 및 에러 처리 로직을 중앙화하면 코드 중복을 줄이고 일관성을 유지할 수 있습니다.
7. TypeScript의 타입 시스템을 활용하면 컴파일 시점에 많은 잠재적 에러를 방지할 수 있습니다.
8. 치명적이지 않은 에러는 사용자 경험을 해치지 않도록 적절히 처리하는 것이 중요합니다. 