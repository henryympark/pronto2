# Pronto 서비스 데이터베이스 스키마 v1.3 (2025년 5월 10일 업데이트)

*(참고: 본 문서는 PRD v4.20 및 TDD v1.7을 기준으로 작성되었습니다.)*
**(변경 이력: v1.3 - 2025년 5월 10일, 시간 선택 UI UX 상세화에 따른 API 응답 필드 설명 보완; v1.2 - 2025년 5월 9일, 예약 연장 및 동시간대 예약 처리를 위한 제약 조건 추가)**

---

## 1. 개요 (Overview)

| 항목         | 내용                                                                                            |
| ---------- | --------------------------------------------------------------------------------------------- |
| **데이터베이스** | PostgreSQL (via Supabase)                                                                     |
| **설계 목표**  | 서비스 요구사항(PRD v4.18)을 충족하며, **데이터 정합성·확장성·성능**을 고려하여 설계합니다. 정규화를 통해 데이터 중복을 최소화하고 관계를 명확히 합니다. |
| **비고**     | 본 문서는 **개념적인 스키마**를 설명하며, 실제 구현 시 필요한 인덱스·제약 조건 상세·RLS 정책 등은 별도의 기술 설계 또는 DB 설계 단계에서 구체화됩니다.  |

---

## 2. 엔티티 및 관계 설명 (Entities & Relationships)

### 주요 엔티티

| 엔티티                                  | 설명                                                                         |
| ------------------------------------ | -------------------------------------------------------------------------- |
| **고객 (customers)**                   | 서비스를 이용하는 사용자 정보 *(일반 고객 및 운영자 포함)*. Supabase 인증 시스템(`auth.users`)과 연결됩니다. |
| **서비스 (services)**                   | 예약 대상이 되는 공간 또는 서비스 정보.                                                    |
| **예약 (reservations)**                | 고객이 특정 서비스(공간)를 특정 시간에 예약한 정보.                                             |
| **리뷰 (reviews)**                     | 고객이 이용 완료한 예약에 대해 작성한 후기 *(별점, 텍스트, 이미지 포함)*.                              |
| **쿠폰 (customer\_coupons)**           | 운영자가 고객에게 부여한 쿠폰 정보.                                                       |
| **휴무일 (holidays)**                   | 운영자가 설정한 날짜 단위 예약 불가 정보.                                                   |
| **서비스 이용불가 패턴 (service_unavailable_patterns)** | 운영자가 설정한 특정 요일/시간대의 정기 휴식 시간(Break Time) 패턴.                              |
| *(향후)* **업체 (businesses)**           | 다중 업체 모델 도입 시 입점 업체 정보.                                                    |
| *(향후)* **업체 멤버 (business\_members)** | 고객과 업체 간의 관계 및 역할 정보.                                                      |

### 주요 관계

* **고객(1) : 예약(N)**
* **고객(1) : 리뷰(N)**
* **고객(1) : 쿠폰(N)**
* **서비스(1) : 예약(N)**
* **서비스(1) : 리뷰(N)**
* **서비스(1) : 서비스 이용불가 패턴(N)**
* **예약(1) : 리뷰(1)**
* **예약(1) : 사용된 쿠폰(N)** *(M\:N 이지만 예약 테이블에 ID 목록 저장 또는 별도 매핑 테이블 고려)*
* *(향후)* **업체(1) : 서비스(N)**
* *(향후)* **업체(1) : 업체 멤버(N)**
* *(향후)* **고객(1) : 업체 멤버(N)**

---

## 3. 개념적 데이터 모델 (Conceptual Data Model)

> *상세 컬럼 타입·제약 조건 등은 제외하고 개념적 정보 중심으로 기술합니다.*

### 3‑1. 고객 (customers)

| 항목        | 내용                                                                                                                                                                                                                                                                    |
| --------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **목적**    | 고객 정보 및 인증 관련 데이터 관리.                                                                                                                                                                                                                                                 |
| **주요 정보** | 고유 식별자 *(Supabase Auth 연동)*, 이메일, `hashed_password` (이메일 가입 시), 이름, 연락처, **인증 방식**(`kakao`,`naver`,`email`), `provider_id` (소셜 로그인 ID), 프로필 이미지 URL, `accumulated_time_minutes` (적립 시간 잔액), 계정 활성 상태, **역할**(`customer`,`admin`), 생성/수정 시각, `deleted_at` (삭제/비활성 시각). |

### 3‑2. 서비스 (services)

| 항목        | 내용                                                                                                                                                      |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **목적**    | 제공되는 예약 서비스(공간) 정보 관리.                                                                                                                                  |
| **주요 정보** | 고유 식별자, 서비스명, 설명, 가격, 위치, 대표 이미지 URL, 주의사항/약관, 환불 정책, **평균 별점**, 리뷰 수, **운영 시작 시간**, **운영 종료 시간**, 생성/수정 시각 *(향후: 업체 식별자)* |

### 3‑3. 예약 (reservations)

| 항목        | 내용                                                                                                                                                                                                |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **목적**    | 고객의 예약 정보 관리.                                                                                                                                                                                     |
| **주요 정보** | 고유 식별자, **고객 ID**, **서비스 ID**, 예약 시작/종료 시각, **예약 상태**, 고객 요청사항, 차량번호, 개인정보 동의 여부, `used_coupon_ids` (사용 쿠폰 ID 목록), `used_accumulated_time_minutes`, `paid_amount`, 운영자 메모, 생성/수정 시각 *(향후: 업체 ID)* |

### 3‑4. 리뷰 (reviews)

| 항목        | 내용                                                                                                       |
| --------- | -------------------------------------------------------------------------------------------------------- |
| **목적**    | 고객 리뷰 정보 관리.                                                                                             |
| **주요 정보** | 고유 식별자, 작성 고객 ID, 관련 예약 ID, 관련 서비스 ID, 별점, 리뷰 텍스트, 첨부 이미지 URL 목록, `is_hidden`, 생성/수정/삭제 시각 *(향후: 업체 ID)* |

### 3‑5. 쿠폰 (customer\_coupons)

| 항목        | 내용                                                                                                           |
| --------- | ------------------------------------------------------------------------------------------------------------ |
| **목적**    | 고객에게 부여된 쿠폰 정보 관리.                                                                                           |
| **주요 정보** | 고유 ID (PK), 고객 ID (FK), **쿠폰 값**(30 분 고정), 부여 일시, **만료 일시**(발급일+3개월), 사용 일시(`NULL` 가능), 사용된 예약 ID(`NULL` 가능) |

### 3‑6. 휴무일 (holidays)

| 항목        | 내용                                      |
| --------- | --------------------------------------- |
| **목적**    | 운영자가 설정한 특정 날짜의 휴무일 정보 관리.                 |
| **주요 정보** | 고유 ID, 휴무 날짜, 설명 *(향후: 업체 ID)* |

### 3‑7. 서비스 이용불가 패턴 (service_unavailable_patterns)

| 항목        | 내용                                                                                                  |
| --------- | --------------------------------------------------------------------------------------------------- |
| **목적**    | 운영자가 설정한 특정 요일/시간대의 정기 휴식 시간(Break Time) 패턴 관리.                                                    |
| **주요 정보** | 고유 ID, 서비스 ID (FK), 패턴 유형(`break`, `closed_time`), 요일(0-6), 시작 시간(TIME), 종료 시간(TIME), 적용 시작일, 적용 종료일 |

### *(향후 확장)* 3‑8. 업체 (businesses)

| 항목        | 내용                       |
| --------- | ------------------------ |
| **목적**    | 입점 업체 정보 관리.             |
| **주요 정보** | 업체 ID, 업체명, 사업자 정보, 상태 등 |

### *(향후 확장)* 3‑9. 업체 멤버 (business\_members)

| 항목        | 내용                                                     |
| --------- | ------------------------------------------------------ |
| **목적**    | 고객과 업체 간의 관계 및 역할 관리.                                  |
| **주요 정보** | 고유 ID, 고객 ID(FK), 업체 ID(FK), **역할**(`owner`,`staff`) 등 |

---

## 4. 주요 데이터 처리 고려사항 (Key Data Processing Considerations)

1. **중복 예약 방지**

   * 특정 서비스의 동일 시작 시간에는 하나의 예약만 가능하도록 DB 제약(UNIQUE) 및 트랜잭션으로 방지.

2. **적립/쿠폰 시간 관리**

   * 리뷰 작성 시 적립 시간 부여.
   * 예약 시 쿠폰 우선 사용 및 적립 시간 차감 로직을 트랜잭션으로 보장.
   * 쿠폰 만료 처리를 위한 스케줄링 작업 필요.

3. **평균 별점/리뷰 수**

   * 성능을 위해 `services` 테이블에 집계 값 저장 후 **비동기 업데이트** 고려.

4. **회원 탈퇴**

   * `is_active=false` 후 30 일 유예 → 익명화.
   * 관계 데이터(예약·리뷰)는 유지하며 익명 ID로 전환.

5. **예약 가능 시간 계산 최적화**
   * 특정 날짜의 예약 가능 시간을 계산할 때, 서비스의 운영 시간, 기존 예약 정보, 휴무일, 정기 휴식 패턴을 모두 고려해야 함.
   * DB의 예약 가능 시간 조회 쿼리를 최적화하여 응답 속도 개선.

6. **확장성**

   * 다중 업체 지원 대비 **business\_id** 컬럼을 주요 테이블에 추가할 수 있도록 구조 미리 고려.

---

## 1. 테이블 구조

### 예약 (Reservations)

* **테이블명**: `reservations`
* **설명**: 고객이 생성한 예약 정보를 관리합니다.
* **컬럼**:
    * `id`: uuid PRIMARY KEY (예약 ID)
    * `user_id`: uuid NOT NULL REFERENCES auth.users(id) (예약자 유저 ID)
    * `customer_id`: uuid NOT NULL REFERENCES customers(id) (예약자 고객 ID)
    * `service_id`: uuid NOT NULL REFERENCES services(id) (예약 대상 서비스 ID)
    * `start_time`: timestamptz NOT NULL (예약 시작 시간)
    * `end_time`: timestamptz NOT NULL (예약 종료 시간)
    * `status`: enum('pending', 'pending_payment', 'confirmed', 'cancelled', 'modified', 'completed') NOT NULL DEFAULT 'pending' (예약 상태)
    * `paid_amount`: integer DEFAULT 0 (결제 금액)
    * `paid_at`: timestamptz (결제 시간)
    * `payment_method`: text (결제 방법)
    * `payment_id`: text (결제 ID)
    * `refunded`: boolean DEFAULT false (환불 여부)
    * `refunded_at`: timestamptz (환불 시간)
    * `memo`: text (메모)
    * `operator_memo`: text (운영자 메모)
    * `used_coupon_ids`: uuid[] (사용한 쿠폰 ID 목록)
    * `used_accumulated_time_minutes`: integer DEFAULT 0 (사용한 적립 시간)
    * `extension_count`: integer DEFAULT 0 (예약 연장 횟수) (신규 추가)
    * `last_extended_at`: timestamptz (마지막 연장 시간) (신규 추가)
    * `originally_paid_amount`: integer (최초 결제 금액) (신규 추가)
    * `extended_paid_amount`: integer DEFAULT 0 (연장으로 추가 결제된 총 금액) (신규 추가)
    * `created_at`: timestamptz DEFAULT now() NOT NULL (생성 시간)
    * `updated_at`: timestamptz DEFAULT now() NOT NULL (수정 시간)
    * `deleted_at`: timestamptz (삭제 시간)
* **인덱스**:
    * PRIMARY KEY: `id`
    * FK INDEX: `user_id`, `customer_id`, `service_id`
    * 조회용 INDEX: `(service_id, start_time)`, `status`, `created_at`
* **제약 조건**:
    * UNIQUE(`service_id`, `start_time`, `status`) WHERE `status` = 'confirmed' (동일 서비스, 동일 시작 시간에 confirmed 상태인 예약은 하나만 존재할 수 있음 - 중복 예약 방지)
    * CHECK(`end_time` > `start_time`) (종료 시간이 시작 시간보다 미래여야 함)
    * CHECK(`extension_count` >= 0) (신규 추가)
    * CHECK(`extended_paid_amount` >= 0) (신규 추가)
* **특이사항**:
    * `status`가 'confirmed'인 예약에 대해 (`service_id`, `start_time`) 조합의 고유성이 보장되어야 함 (RLS, 애플리케이션 레벨 검증 필요).
    * 예약 연장 시 `end_time` 업데이트, `extension_count` +1, `last_extended_at` 설정, `extended_paid_amount` 누적 필요.

*end of document*
