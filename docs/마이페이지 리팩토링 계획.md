# 마이페이지 리팩토링 계획

## 현재 문제점 분석

### 1. 파일 크기 및 복잡도
- **현재 파일 크기**: 35,871 바이트 (약 36KB)
- **코드 라인 수**: 약 1,000줄
- **주요 문제점**:
  - 단일 컴포넌트에 너무 많은 책임이 집중됨
  - 상태 관리 로직과 UI 로직이 혼재
  - 재사용 가능한 컴포넌트로 분리되지 않음

### 2. 주요 기능 분석
현재 마이페이지에서 처리하는 기능들:
- 사용자 인증 상태 관리
- 예약 목록 조회 및 필터링
- 예약 상세 정보 표시
- 예약 취소 처리
- 예약 연장 처리
- 통계 정보 표시 (적립시간, 쿠폰, 리뷰)
- 실시간 상태 업데이트
- 실시간 쿠폰 업데이트 구독

## 리팩토링 방안

### 1. 디렉토리 구조 개선

```
src/
├── app/
│   └── my/
│       ├── page.tsx (메인 페이지 - 간소화)
│       └── components/
│           ├── MyPageLayout.tsx
│           ├── StatsSection.tsx
│           ├── ReservationList.tsx
│           ├── ReservationCard.tsx
│           └── UserActions.tsx
├── features/
│   └── my-page/
│       ├── hooks/
│       │   ├── useReservations.ts
│       │   ├── useUserStats.ts
│       │   ├── useReservationActions.ts
│       │   └── useRealtimeSubscriptions.ts
│       ├── components/
│       │   ├── ReservationDetailModal.tsx
│       │   ├── CancelReservationModal.tsx
│       │   ├── ReservationFilters.tsx
│       │   └── ReservationStatusBadge.tsx
│       └── utils/
│           ├── reservation-helpers.ts
│           └── status-helpers.ts
```

### 2. 분리할 컴포넌트 및 로직

#### A. 커스텀 훅으로 분리할 로직

**1. `useReservations.ts`**
```typescript
// 예약 목록 관리 로직
export function useReservations(userId: string) {
  const [reservations, setReservations] = useState<Reservation[]>([]);
  const [filteredReservations, setFilteredReservations] = useState<Reservation[]>([]);
  const [activeFilter, setActiveFilter] = useState<FilterType>('upcoming');
  const [isLoading, setIsLoading] = useState(true);
  const [hasError, setHasError] = useState(false);
  const [errorMessage, setErrorMessage] = useState("");

  // fetchReservations 로직
  // applyFilter 로직
  // handleFilterChange 로직
  
  return {
    reservations,
    filteredReservations,
    activeFilter,
    isLoading,
    hasError,
    errorMessage,
    fetchReservations,
    handleFilterChange,
    refreshReservations
  };
}
```

**2. `useUserStats.ts`**
```typescript
// 사용자 통계 정보 관리
export function useUserStats(userId: string) {
  const [accumulatedTime, setAccumulatedTime] = useState(0);
  const [couponsCount, setCouponsCount] = useState(0);
  const [reviewsCount, setReviewsCount] = useState(0);
  const [isLoading, setIsLoading] = useState(true);

  // fetchSimplifiedData 로직
  
  return {
    accumulatedTime,
    couponsCount,
    reviewsCount,
    isLoading,
    refreshStats
  };
}
```

**3. `useReservationActions.ts`**
```typescript
// 예약 액션 관리 (취소, 연장 등)
export function useReservationActions() {
  const [isCancelModalOpen, setIsCancelModalOpen] = useState(false);
  const [cancelingReservation, setCancelingReservation] = useState<Reservation | null>(null);
  const [isCancelling, setIsCancelling] = useState(false);
  const [isExtensionModalOpen, setIsExtensionModalOpen] = useState(false);
  const [extendingReservation, setExtendingReservation] = useState<Reservation | null>(null);

  // handleCancelReservation 로직
  // handleExtensionClick 로직
  // handleExtensionSuccess 로직
  
  return {
    cancelState: { isCancelModalOpen, cancelingReservation, isCancelling },
    extensionState: { isExtensionModalOpen, extendingReservation },
    actions: {
      openCancelModal,
      closeCancelModal,
      confirmCancel,
      openExtensionModal,
      closeExtensionModal,
      handleExtensionSuccess
    }
  };
}
```

**4. `useRealtimeSubscriptions.ts`**
```typescript
// 실시간 업데이트 구독 관리
export function useRealtimeSubscriptions(userId: string, options: {
  onReservationCreated?: () => void;
  onCouponUpdated?: () => void;
}) {
  // 예약 생성 이벤트 리스너
  // 실시간 상태 업데이트 타이머
  // 쿠폰 업데이트 구독
}
```

#### B. UI 컴포넌트로 분리

**1. `StatsSection.tsx`**
```typescript
interface StatsSectionProps {
  accumulatedTime: number;
  couponsCount: number;
  reviewsCount: number;
  onStatsCardClick: (path: string) => void;
}

export function StatsSection({ 
  accumulatedTime, 
  couponsCount, 
  reviewsCount, 
  onStatsCardClick 
}: StatsSectionProps) {
  // 통계 카드 섹션 UI
}
```

**2. `ReservationList.tsx`**
```typescript
interface ReservationListProps {
  reservations: Reservation[];
  isLoading: boolean;
  activeFilter: FilterType;
  onFilterChange: (filter: FilterType) => void;
  onReservationClick: (reservation: Reservation) => void;
  onExtensionClick: (reservation: Reservation) => void;
}

export function ReservationList(props: ReservationListProps) {
  // 예약 목록 및 필터 UI
}
```

**3. `ReservationCard.tsx`**
```typescript
interface ReservationCardProps {
  reservation: Reservation;
  activeFilter: FilterType;
  onCardClick: () => void;
  onExtensionClick: () => void;
}

export function ReservationCard(props: ReservationCardProps) {
  // 개별 예약 카드 UI
}
```

**4. `ReservationDetailModal.tsx`**
```typescript
interface ReservationDetailModalProps {
  reservation: Reservation | null;
  isOpen: boolean;
  onClose: () => void;
  onCancelClick: () => void;
  onExtensionClick: () => void;
}

export function ReservationDetailModal(props: ReservationDetailModalProps) {
  // 예약 상세 정보 모달 UI
}
```

**5. `ReservationStatusBadge.tsx`**
```typescript
interface ReservationStatusBadgeProps {
  reservation: Reservation;
}

export function ReservationStatusBadge({ reservation }: ReservationStatusBadgeProps) {
  // 예약 상태 배지 UI (아이콘, 색상, 텍스트 로직 포함)
}
```

#### C. 유틸리티 함수로 분리

**1. `reservation-helpers.ts`**
```typescript
// 예약 관련 헬퍼 함수들
export function formatTimeString(timeStr: string): string { ... }
export function canCancelReservation(reservation: Reservation): boolean { ... }
export function getReservationTimeStatus(reservation: Reservation): TimeStatus { ... }
```

**2. `status-helpers.ts`**
```typescript
// 상태 관련 헬퍼 함수들
export function getStatusIcon(reservation: Reservation): JSX.Element { ... }
export function getStatusColorClass(reservation: Reservation): string { ... }
export function getStatusText(reservation: Reservation): string { ... }
```

### 3. 리팩토링된 메인 페이지 구조

```typescript
// src/app/my/page.tsx
"use client";

import { MyPageLayout } from './components/MyPageLayout';
import { StatsSection } from './components/StatsSection';
import { ReservationList } from './components/ReservationList';
import { UserActions } from './components/UserActions';
import { useAuth } from '@/contexts/AuthContext';
import { useReservations } from '@/features/my-page/hooks/useReservations';
import { useUserStats } from '@/features/my-page/hooks/useUserStats';
import { useReservationActions } from '@/features/my-page/hooks/useReservationActions';
import { useRealtimeSubscriptions } from '@/features/my-page/hooks/useRealtimeSubscriptions';
import { ReservationDetailModal } from '@/features/my-page/components/ReservationDetailModal';
import { CancelReservationModal } from '@/features/my-page/components/CancelReservationModal';
import { ExtensionModal } from '@/components/reservation';

export default function MyPage() {
  const { user, loading, signOut } = useAuth();
  const router = useRouter();
  
  // 커스텀 훅 사용
  const reservations = useReservations(user?.id);
  const stats = useUserStats(user?.id);
  const actions = useReservationActions();
  
  // 실시간 구독
  useRealtimeSubscriptions(user?.id, {
    onReservationCreated: reservations.refreshReservations,
    onCouponUpdated: stats.refreshStats,
  });

  // 로딩 및 인증 체크
  if (loading) return <LoadingState />;
  if (!user) return <RedirectToLogin />;

  return (
    <MyPageLayout>
      <StatsSection
        accumulatedTime={stats.accumulatedTime}
        couponsCount={stats.couponsCount}
        reviewsCount={stats.reviewsCount}
        onStatsCardClick={(path) => router.push(path)}
      />
      
      <ReservationList
        reservations={reservations.filteredReservations}
        isLoading={reservations.isLoading}
        activeFilter={reservations.activeFilter}
        onFilterChange={reservations.handleFilterChange}
        onReservationClick={(res) => actions.actions.openDetailModal(res)}
        onExtensionClick={(res) => actions.actions.openExtensionModal(res)}
      />
      
      <UserActions onSignOut={signOut} />
      
      {/* 모달들 */}
      <ReservationDetailModal {...detailModalProps} />
      <CancelReservationModal {...cancelModalProps} />
      <ExtensionModal {...extensionModalProps} />
    </MyPageLayout>
  );
}
```

## 구현 우선순위

1. **Phase 1**: 커스텀 훅 분리
   - `useReservations.ts` 생성
   - `useUserStats.ts` 생성
   - 기존 로직을 훅으로 이동

2. **Phase 2**: UI 컴포넌트 분리
   - `StatsSection.tsx` 생성
   - `ReservationList.tsx` 생성
   - `ReservationCard.tsx` 생성

3. **Phase 3**: 유틸리티 함수 분리
   - `reservation-helpers.ts` 생성
   - `status-helpers.ts` 생성

4. **Phase 4**: 모달 컴포넌트 분리
   - `ReservationDetailModal.tsx` 생성
   - `CancelReservationModal.tsx` 생성

5. **Phase 5**: 실시간 구독 로직 분리
   - `useRealtimeSubscriptions.ts` 생성

## 예상 효과

1. **코드 가독성 향상**
   - 메인 페이지 파일 크기 80% 감소 (약 200줄로 축소)
   - 각 컴포넌트와 훅의 단일 책임 원칙 준수

2. **유지보수성 향상**
   - 기능별로 분리된 모듈로 수정이 용이
   - 테스트 작성이 쉬워짐

3. **재사용성 향상**
   - 분리된 컴포넌트와 훅을 다른 페이지에서도 사용 가능
   - 공통 로직의 중복 제거

4. **성능 개선**
   - 필요한 컴포넌트만 렌더링
   - 메모이제이션 적용이 용이해짐


## planner 모드

### 📊 현재 상황 분석

**검증된 현재 파일 상태**:
- **실제 파일 크기**: 36KB (876줄) - 문서 예상과 일치
- **주요 문제점 확인**: 단일 파일에 과도한 책임 집중
- **복잡도**: 약 30개의 useState, 15개의 커스텀 함수, 다양한 UI 로직 혼재

**프로젝트 구조 현황**:
```
src/
├── components/ (기존 공통 컴포넌트)
├── hooks/ (기존 커스텀 훅들)
├── app/my/page.tsx (876줄 - 리팩토링 대상)
├── lib/ (유틸리티 함수들)
├── types/ (타입 정의)
└── contexts/ (인증, Supabase 컨텍스트)
```

### 🎯 리팩토링 실행 계획

#### **Phase 1: 커스텀 훅 분리 (최우선순위)**
**예상 작업 시간**: 3-4시간

**1-1. `useReservations.ts` 생성 (1.5시간)**
- **추출할 로직**:
  ```typescript
  // 현재 page.tsx에서 추출할 상태들
  - reservations, filteredReservations, activeFilter
  - isLoading, hasError, errorMessage
  - fetchReservations, applyFilter, handleFilterChange 함수들
  ```
- **성공 기준**: 예약 관련 모든 상태와 로직이 훅으로 분리되어 page.tsx에서 사용 가능
- **테스트 방법**: 기존 기능 동일하게 작동하는지 확인

**1-2. `useUserStats.ts` 생성 (1시간)**
- **추출할 로직**:
  ```typescript
  // 통계 관련 상태들
  - accumulatedTime, couponsCount, reviewsCount
  - fetchSimplifiedData 함수
  ```
- **성공 기준**: 통계 카드 데이터가 독립적인 훅으로 관리됨
- **테스트 방법**: 통계 카드 표시 및 클릭 기능 정상 작동

**1-3. `useReservationActions.ts` 생성 (1.5시간)**
- **추출할 로직**:
  ```typescript
  // 예약 액션 관련 상태들
  - 취소 모달: isCancelModalOpen, cancelingReservation, isCancelling
  - 연장 모달: isExtensionModalOpen, extendingReservation
  - 액션 함수들: handleCancelReservation, handleExtensionClick 등
  ```
- **성공 기준**: 모든 예약 액션이 훅으로 분리되어 독립적으로 작동
- **테스트 방법**: 예약 취소, 연장 기능 정상 작동

#### **Phase 2: UI 컴포넌트 분리 (2순위)**
**예상 작업 시간**: 4-5시간

**2-1. `StatsSection.tsx` 생성 (1시간)**
- **구현 범위**: 
  ```typescript
  // 통계 카드 섹션 (라인 500-600 정도)
  - 적립시간, 쿠폰, 리뷰 카드
  - 클릭 핸들러 props로 받기
  - 호버 효과 및 애니메이션 유지
  ```
- **성공 기준**: 독립적인 컴포넌트로 분리되어 재사용 가능
- **설치 필요**: 추가 shadcn 컴포넌트 없음 (기존 Card 사용)

**2-2. `ReservationList.tsx` 생성 (1.5시간)**
- **구현 범위**:
  ```typescript
  // 예약 목록 및 필터 (라인 600-700 정도)
  - Tabs 기반 필터 UI
  - 예약 목록 렌더링 로직
  - 로딩/에러 상태 처리
  ```
- **성공 기준**: 필터링과 목록 표시가 독립 컴포넌트로 작동
- **의존성**: ReservationCard 컴포넌트 필요

**2-3. `ReservationCard.tsx` 생성 (1.5시간)**
- **구현 범위**:
  ```typescript
  // 개별 예약 카드 (라인 700-800 정도)
  - 예약 정보 표시 로직
  - 상태 아이콘, 배지, 색상 로직
  - 클릭 이벤트 핸들러
  ```
- **성공 기준**: 예약 카드가 독립적으로 렌더링되고 상호작용 가능
- **분리 대상**: getStatusIcon, getStatusColorClass, getStatusText 함수들

**2-4. `MyPageLayout.tsx` 생성 (1시간)**
- **구현 범위**:
  ```typescript
  // 페이지 전체 레이아웃
  - 헤더 (사용자 정보, 로그아웃 버튼)
  - 새로고침 버튼
  - 메인 컨테이너 구조
  ```
- **성공 기준**: 재사용 가능한 레이아웃 컴포넌트로 분리

#### **Phase 3: 유틸리티 함수 분리 (3순위)**
**예상 작업 시간**: 1-2시간

**3-1. `reservation-helpers.ts` 생성 (1시간)**
- **분리할 함수들**:
  ```typescript
  // 현재 page.tsx의 함수들
  - formatTimeString
  - getReservationTimeStatus  
  - canCancelReservation
  ```
- **성공 기준**: 순수 함수로 분리되어 테스트 가능
- **위치**: `src/features/my-page/utils/`

**3-2. `status-helpers.ts` 생성 (1시간)**
- **분리할 함수들**:
  ```typescript
  // UI 관련 헬퍼 함수들
  - getStatusIcon
  - getStatusColorClass
  - getStatusText
  ```
- **성공 기준**: UI 상태 관련 로직이 독립적으로 관리됨

#### **Phase 4: 모달 컴포넌트 분리 (4순위)**
**예상 작업 시간**: 2-3시간

**4-1. `ReservationDetailModal.tsx` 생성 (1시간)**
- **구현 범위**: 예약 상세 정보 모달 (현재 라인 800-850)
- **기능**: 예약 정보 표시, 이력 타임라인, 액션 버튼들
- **성공 기준**: 독립적인 모달 컴포넌트로 재사용 가능

**4-2. `CancelReservationModal.tsx` 생성 (1시간)**
- **구현 범위**: 예약 취소 확인 모달
- **기능**: 취소 확인, 로딩 상태, 에러 처리
- **성공 기준**: 취소 프로세스가 독립적으로 작동

**4-3. 기존 `ExtensionModal` 통합 (30분)**
- **작업**: 이미 존재하는 컴포넌트와의 통합 확인
- **성공 기준**: 일관된 모달 인터페이스 제공

#### **Phase 5: 실시간 구독 로직 분리 (5순위)**
**예상 작업 시간**: 1-2시간

**5-1. `useRealtimeSubscriptions.ts` 생성 (1.5시간)**
- **분리할 로직**:
  ```typescript
  // 현재 useEffect 로직들
  - 예약 생성 이벤트 수신
  - 실시간 상태 업데이트 타이머
  - 쿠폰 업데이트 구독 (향후 확장)
  ```
- **성공 기준**: 실시간 기능이 독립적인 훅으로 관리됨

### 📁 최종 디렉토리 구조

```
src/
├── app/my/
│   ├── page.tsx (200줄 이하로 축소)
│   └── components/
│       ├── MyPageLayout.tsx
│       ├── StatsSection.tsx
│       ├── ReservationList.tsx
│       └── ReservationCard.tsx
├── features/my-page/
│   ├── hooks/
│   │   ├── useReservations.ts
│   │   ├── useUserStats.ts
│   │   ├── useReservationActions.ts
│   │   └── useRealtimeSubscriptions.ts
│   ├── components/
│   │   ├── ReservationDetailModal.tsx
│   │   └── CancelReservationModal.tsx
│   └── utils/
│       ├── reservation-helpers.ts
│       └── status-helpers.ts
```

### 🎯 실행 전략

#### **리스크 관리**
1. **기존 기능 보존**: 각 단계마다 기능 테스트 필수
2. **점진적 마이그레이션**: 한 번에 하나의 Phase만 진행
3. **롤백 계획**: 각 단계별 커밋으로 롤백 가능하게 관리

#### **테스트 계획**
1. **Phase별 기능 테스트**: 각 단계 완료 후 전체 기능 검증
2. **성능 모니터링**: 리팩토링 후 로딩 시간 비교
3. **사용자 시나리오**: 예약 조회, 취소, 연장 등 핵심 플로우 테스트

#### **예상 효과 측정**
- **파일 크기**: 36KB → 8KB 이하 (메인 페이지)
- **코드 라인**: 876줄 → 200줄 이하 (메인 페이지)
- **컴포넌트 재사용성**: 5개 이상의 재사용 가능한 컴포넌트 생성
- **유지보수성**: 기능별 독립 모듈로 수정 용이성 확보

### 🚀 다음 단계

**준비 완료 상태**: Phase 1부터 순차적 실행 준비
**첫 번째 작업**: `useReservations.ts` 훅 생성 (Executor 모드 전환 시)
**성공 기준**: 각 Phase 완료 후 기존 기능 100% 동일하게 작동



\